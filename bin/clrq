#!/bin/bash

if [[ $# == 2 ]]; then
    SED_CMD="sed -n -e '/^${1}/,/^${2}/p'"
elif [[ $# == 1 ]]; then
    SED_CMD="sed -n -e '/^${1}/,//p'"
else
    SED_CMD="sed '1d'"
fi

for qid in `eval "lsq | ${SED_CMD} | grep pending | cut -f1"`; do
    deq $qid
done

rmq

eval "lsq | ${SED_CMD} | grep running" | while read line; do
    mid=`echo -n $line | cut -d" " -f4`
    proc=`echo -n $line | cut -d" " -f7`
    echo "Killing process ${proc} on ${mid}..."
    ssh $mid -- killall python < /dev/null
    ssh $mid -- killall `basename $proc` < /dev/null
done

rmq
